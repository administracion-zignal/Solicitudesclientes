<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; style-src * 'unsafe-inline';">
    <title>Zignal Agency | Notion-Style Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.292.0/dist/umd/lucide.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { zignal: { blue: '#0066FF', cyan: '#00E5FF', dark: '#0B1120' } }
                }
            }
        }
    </script>
</head>
<body class="bg-[#FBFBFA] text-slate-800 antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const SUPABASE_URL = 'https://vknnukcicqkufdhutuip.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrbm51a2NpY3FrdWZkaHV0dWlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk0NTI3NDAsImV4cCI6MjA1NTAyODc0MH0.xV8A56N_9i-xL8S_2XvjA8uL1nO-R28I_xM7-U1-G9Y'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const Icon = ({ name, size = 16, className = "" }) => {
            const svg = useMemo(() => {
                if (!window.lucide || !window.lucide.icons[name]) return null;
                const el = window.lucide.createElement(window.lucide.icons[name]);
                el.setAttribute('width', size); el.setAttribute('height', size);
                return { __html: el.outerHTML };
            }, [name, size]);
            return svg ? <span dangerouslySetInnerHTML={svg} className={`inline-flex ${className}`} /> : null;
        };

        const CalendarMonth = ({ year, month, tasks, notes, onDayClick }) => {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            const monthLabel = new Date(year, month).toLocaleString('es-ES', { month: 'long' });

            const days = [];
            for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="h-32 bg-slate-50/50 border-[0.5px] border-slate-100"></div>);
            
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayTasks = tasks.filter(t => t.deadline === dateStr || t.request_date === dateStr);
                const dayNotes = notes.filter(n => n.fecha === dateStr);

                days.push(
                    <div key={d} onClick={() => onDayClick(dateStr)} className="h-32 border-[0.5px] border-slate-200 bg-white p-2 hover:bg-slate-50 transition-colors cursor-pointer group relative overflow-hidden">
                        <span className="text-xs font-bold text-slate-400 group-hover:text-zignal-blue">{d}</span>
                        <div className="mt-1 space-y-1 overflow-y-auto max-h-[85%] no-scrollbar">
                            {dayTasks.map(t => (
                                <div key={t.id} className="text-[9px] px-1.5 py-0.5 rounded bg-blue-50 text-blue-700 border border-blue-100 truncate font-bold">
                                    {t.request_date === dateStr ? 'üöÄ ' : 'üèÅ '}{t.campaign_name}
                                </div>
                            ))}
                            {dayNotes.map(n => (
                                <div key={n.id} className={`text-[9px] px-1.5 py-0.5 rounded border truncate font-medium ${n.tipo === 'Festivo' ? 'bg-red-50 text-red-600 border-red-100' : 'bg-amber-50 text-amber-700 border-amber-100'}`}>
                                    üìù {n.contenido}
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex-none w-full md:w-[400px] border border-slate-200 rounded-2xl overflow-hidden shadow-sm">
                    <div className="bg-white p-3 text-center border-b font-black uppercase tracking-widest text-slate-700">{monthLabel} {year}</div>
                    <div className="grid grid-cols-7 bg-slate-50 text-[9px] font-bold text-slate-400 text-center py-2">
                        <div>DOM</div><div>LUN</div><div>MAR</div><div>MIE</div><div>JUE</div><div>VIE</div><div>SAB</div>
                    </div>
                    <div className="grid grid-cols-7 border-t border-slate-100">{days}</div>
                </div>
            );
        };

        const App = () => {
            const [tasks, setTasks] = useState([]);
            const [notes, setNotes] = useState([]);
            const [isTaskModal, setIsTaskModal] = useState(false);
            const [isNoteModal, setIsNoteModal] = useState(false);
            const [selectedDate, setSelectedDate] = useState('');
            const [loading, setLoading] = useState(true);

            const fetchData = async () => {
                const [tRes, nRes] = await Promise.all([
                    supabaseClient.from('solicitudes').select('*'),
                    supabaseClient.from('notas_calendario').select('*')
                ]);
                if (!tRes.error) setTasks(tRes.data);
                if (!nRes.error) setNotes(nRes.data);
                setLoading(false);
            };

            useEffect(() => {
                fetchData();
                const channel = supabaseClient.channel('realtime').on('postgres_changes', {event:'*', schema:'public'}, fetchData).subscribe();
                return () => supabaseClient.removeChannel(channel);
            }, []);

            const handleSaveNote = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                await supabaseClient.from('notas_calendario').insert([{
                    fecha: selectedDate,
                    contenido: formData.get('content'),
                    tipo: formData.get('type')
                }]);
                setIsNoteModal(false);
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-zignal-dark text-white p-5 flex justify-between items-center sticky top-0 z-50">
                        <div className="flex items-center gap-3">
                            <div className="bg-zignal-blue p-2 rounded-xl"><Icon name="Zap" size={20} /></div>
                            <h1 className="text-xl font-black tracking-tighter">ZIGNAL <span className="text-zignal-cyan">WORKFLOW</span></h1>
                        </div>
                        <button onClick={() => setIsTaskModal(true)} className="bg-zignal-blue hover:bg-blue-600 px-6 py-2.5 rounded-xl font-black text-xs shadow-lg transition-all active:scale-95 flex items-center gap-2">
                            <Icon name="PlusCircle" /> NUEVA SOLICITUD
                        </button>
                    </header>

                    <main className="max-w-7xl mx-auto w-full p-6 space-y-10">
                        {/* CALENDARIO SECTION */}
                        <section className="space-y-4">
                            <div className="flex items-center gap-2">
                                <Icon name="CalendarRange" className="text-zignal-blue" size={24} />
                                <h2 className="text-2xl font-black text-slate-800 tracking-tight">Planificaci√≥n Trimestral 2026</h2>
                            </div>
                            <div className="flex gap-6 overflow-x-auto pb-6 snap-x">
                                <CalendarMonth year={2026} month={1} tasks={tasks} notes={notes} onDayClick={(d) => { setSelectedDate(d); setIsNoteModal(true); }} />
                                <CalendarMonth year={2026} month={2} tasks={tasks} notes={notes} onDayClick={(d) => { setSelectedDate(d); setIsNoteModal(true); }} />
                                <CalendarMonth year={2026} month={3} tasks={tasks} notes={notes} onDayClick={(d) => { setSelectedDate(d); setIsNoteModal(true); }} />
                            </div>
                        </section>

                        {/* LISTADO TAREAS */}
                        <section className="bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden">
                            <div className="p-6 border-b bg-slate-50 font-black text-xs uppercase tracking-widest text-slate-400">Solicitudes Activas</div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <tbody className="divide-y divide-slate-100">
                                        {tasks.map(t => (
                                            <tr key={t.id} className="hover:bg-slate-50 transition-colors">
                                                <td className="p-5 font-bold text-slate-700">{t.campaign_name}</td>
                                                <td className="p-5"><span className="px-3 py-1 rounded-full text-[10px] font-black uppercase bg-blue-50 text-blue-600 border border-blue-100">{t.status}</span></td>
                                                <td className="p-5 text-right font-mono text-xs text-slate-400">Entrega: {t.deadline}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </section>
                    </main>

                    {/* MODAL NOTA (TIPO NOTION) */}
                    {isNoteModal && (
                        <div className="fixed inset-0 bg-zignal-dark/80 backdrop-blur-md z-[100] flex items-center justify-center p-4">
                            <form onSubmit={handleSaveNote} className="bg-white rounded-[2rem] w-full max-w-md shadow-2xl p-8 space-y-6 border border-slate-200 fade-in">
                                <div className="flex justify-between items-center">
                                    <h3 className="font-black text-xl text-slate-800 tracking-tighter">Pauta del D√≠a: {selectedDate}</h3>
                                    <button type="button" onClick={() => setIsNoteModal(false)}><Icon name="X" size={24} className="text-slate-300" /></button>
                                </div>
                                <div>
                                    <label className="text-[10px] font-black uppercase text-slate-400 mb-2 block">Tipo de Actividad</label>
                                    <select name="type" className="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none font-bold">
                                        <option>Nota de Pauta</option><option>Festivo</option><option>Activaci√≥n</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-[10px] font-black uppercase text-slate-400 mb-2 block">Descripci√≥n Libre</label>
                                    <textarea name="content" required className="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none min-h-[150px] font-medium" placeholder="Escribe aqu√≠ las pautas, notas manuales o recordatorios..."></textarea>
                                </div>
                                <button type="submit" className="w-full bg-zignal-dark text-white p-5 rounded-2xl font-black text-sm tracking-widest shadow-xl flex items-center justify-center gap-3">
                                    <Icon name="Save" /> GUARDAR EN CALENDARIO
                                </button>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
