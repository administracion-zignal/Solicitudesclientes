<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; style-src * 'unsafe-inline';">
    
    <title>Zignal Agency | Dashboard Cloud</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.292.0/dist/umd/lucide.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { zignal: { blue: '#0066FF', cyan: '#00E5FF', dark: '#0B1120', light: '#F0F9FF', gray: '#1E293B', danger: '#EF4444' } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; }
        .calendar-day:active { transform: scale(0.98); }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800 antialiased pb-24">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- CONFIGURACIÓN SUPABASE ---
        const SUPABASE_URL = 'COLOCA_AQUI_TU_URL_DE_SUPABASE'; 
        const SUPABASE_KEY = 'COLOCA_AQUI_TU_ANON_KEY_DE_SUPABASE';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- ICON COMPONENT ---
        const Icon = ({ name, size = 18, className = "" }) => {
            const svgContent = useMemo(() => {
                if (!window.lucide || !window.lucide.icons || !window.lucide.icons[name]) return null;
                const element = window.lucide.createElement(window.lucide.icons[name]);
                element.setAttribute('width', size);
                element.setAttribute('height', size);
                return { __html: element.outerHTML };
            }, [name, size]);
            return svgContent ? <span dangerouslySetInnerHTML={svgContent} className={`inline-flex items-center ${className}`} /> : null;
        };

        const App = () => {
            const [tasks, setTasks] = useState([]);
            const [view, setView] = useState('active');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [loading, setLoading] = useState(true);

            // 1. CARGAR DATOS DESDE LA NUBE (SUPABASE)
            const fetchTasks = async () => {
                setLoading(true);
                const { data, error } = await supabaseClient
                    .from('solicitudes')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (!error) setTasks(data);
                setLoading(false);
            };

            useEffect(() => {
                fetchTasks();
                
                // ESCUCHAR CAMBIOS EN TIEMPO REAL
                const channel = supabaseClient
                    .channel('cambios-reales')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'solicitudes' }, () => {
                        fetchTasks();
                    })
                    .subscribe();

                return () => supabaseClient.removeChannel(channel);
            }, []);

            // 2. GUARDAR EN LA NUBE
            const handleSave = async (formData) => {
                const payload = {
                    campaign_name: formData.campaignName,
                    requester: formData.requester,
                    format: formData.format,
                    status: formData.status,
                    priority: formData.priority,
                    deadline: formData.deadline,
                    description: formData.description,
                    included_in_plan: formData.includedInPlan,
                    price: formData.price
                };

                const { error } = await supabaseClient.from('solicitudes').insert([payload]);
                if (error) alert("Error al guardar: " + error.message);
                setIsModalOpen(false);
            };

            const filteredTasks = tasks.filter(t => view === 'active' ? t.status !== 'Finalized' : t.status === 'Finalized');

            return (
                <div className="min-h-screen">
                    <header className="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-20 shadow-sm">
                        <div className="flex items-center gap-2">
                            <div className="bg-zignal-dark text-white p-2 rounded"><Icon name="Zap" /></div>
                            <h1 className="font-bold text-xl">Zignal Agency Cloud</h1>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-xs text-green-500 font-bold flex items-center gap-1">
                                <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Sincronizado
                            </span>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 space-y-6">
                        {/* Toolbar */}
                        <div className="flex justify-between bg-white p-3 rounded-xl border shadow-sm">
                            <div className="flex bg-gray-100 p-1 rounded-lg">
                                <button onClick={() => setView('active')} className={`px-4 py-2 rounded-md text-xs font-bold ${view === 'active' ? 'bg-white shadow text-zignal-dark' : 'text-gray-500'}`}>Activas</button>
                                <button onClick={() => setView('history')} className={`px-4 py-2 rounded-md text-xs font-bold ${view === 'history' ? 'bg-white shadow text-zignal-dark' : 'text-gray-500'}`}>Historial</button>
                            </div>
                            <button onClick={() => setIsModalOpen(true)} className="bg-zignal-dark text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2">
                                <Icon name="Plus" /> Nueva Solicitud
                            </button>
                        </div>

                        {/* Listado */}
                        <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                            {loading ? <div className="p-10 text-center">Cargando base de datos...</div> : (
                                <table className="w-full text-left">
                                    <thead className="bg-gray-50 text-[10px] uppercase text-gray-400 font-bold">
                                        <tr>
                                            <th className="p-4">Campaña</th>
                                            <th className="p-4">Estatus</th>
                                            <th className="p-4">Prioridad</th>
                                            <th className="p-4 text-right">Entrega</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {filteredTasks.map(t => (
                                            <tr key={t.id} className="hover:bg-gray-50 transition-colors">
                                                <td className="p-4 font-bold">{t.campaign_name}</td>
                                                <td className="p-4 text-xs font-bold uppercase text-blue-600">{t.status}</td>
                                                <td className="p-4 text-xs font-bold uppercase text-red-500">{t.priority}</td>
                                                <td className="p-4 text-right text-gray-500 font-mono text-xs">{t.deadline}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    </main>

                    {/* Modal Pro Prototipo */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl">
                                <h2 className="text-xl font-bold mb-4">Nueva Solicitud Cloud</h2>
                                <input id="cname" className="w-full p-3 border rounded-lg mb-4" placeholder="Nombre de Campaña..." />
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <select id="prio" className="p-3 border rounded-lg bg-white"><option>High</option><option>Medium</option><option>Low</option></select>
                                    <input id="date" type="date" className="p-3 border rounded-lg" />
                                </div>
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-gray-500">Cancelar</button>
                                    <button onClick={() => {
                                        handleSave({
                                            campaignName: document.getElementById('cname').value,
                                            priority: document.getElementById('prio').value,
                                            deadline: document.getElementById('date').value,
                                            status: 'Pending', requester: 'Admin', includedInPlan: true
                                        });
                                    }} className="bg-zignal-dark text-white px-6 py-2 rounded-lg font-bold">Sincronizar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html> 
